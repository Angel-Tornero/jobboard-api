name: Build Spring Boot with Maven

on:
  pull_request:
    paths:
      - '.github/workflows/**/*'
      - 'src/**/*'
      - 'pom.xml'

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest
    
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          architecture: x64
          cache: 'maven'

      - name: Compile and Package (Skip Tests)
        # We use 'package' to build the JAR but skip tests to save time here.
        # Tests will run in the next job.
        run: ./mvnw -B clean package -DskipTests

      - name: Upload Build Artifacts
        # We upload the 'target' directory so the next job can use the compiled classes/JAR
        # without recompiling everything.
        uses: actions/upload-artifact@v4
        with:
          name: maven-target
          path: target/
          retention-days: 1

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: build # This ensures 'test' only runs if 'build' succeeds
    
    permissions:
      checks: write
      pull-requests: write

    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          architecture: x64
          cache: 'maven'

      - name: Download Build Artifacts
        # Download the 'target' folder we created in the 'build' job
        uses: actions/download-artifact@v4
        with:
          name: maven-target
          path: target/

      - name: Run Verification/Tests
        # We run 'verify' but without 'clean' to utilize the downloaded artifacts.
        # This runs unit and integration tests.
        run: ./mvnw -B test
